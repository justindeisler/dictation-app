---
phase: 01-foundation-settings
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - DictationApp/Sources/Services/LoginItemManager.swift
  - DictationApp/Sources/App/AppDelegate.swift
autonomous: true

must_haves:
  truths:
    - "User can toggle launch at login from menu bar menu"
    - "Toggle state reflects actual system state"
    - "User sees guidance if macOS blocks login item registration"
  artifacts:
    - path: "DictationApp/Sources/Services/LoginItemManager.swift"
      provides: "SMAppService wrapper for launch at login"
      exports: ["LoginItemManager"]
    - path: "DictationApp/Sources/App/AppDelegate.swift"
      provides: "Menu toggle wired to LoginItemManager"
      contains: "toggleLaunchAtLogin"
  key_links:
    - from: "DictationApp/Sources/App/AppDelegate.swift"
      to: "LoginItemManager"
      via: "toggle action"
      pattern: "LoginItemManager\\.shared\\.(setEnabled|isEnabled)"
---

<objective>
Implement launch at login functionality with SMAppService and menu bar toggle.

Purpose: Allows users to have the app automatically start when they log in, improving convenience for daily use.

Output: Working "Launch at Login" toggle in menu bar that uses SMAppService and shows guidance when blocked.
</objective>

<execution_context>
@/Users/justindeisler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/justindeisler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-settings/01-RESEARCH.md
@.planning/phases/01-foundation-settings/01-CONTEXT.md
@.planning/phases/01-foundation-settings/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement LoginItemManager with SMAppService</name>
  <files>
    DictationApp/Sources/Services/LoginItemManager.swift
  </files>
  <action>
Create LoginItemManager.swift using SMAppService (macOS 13+):

```swift
import Foundation
import ServiceManagement
import AppKit

enum LoginItemError: LocalizedError {
    case registrationFailed
    case unregistrationFailed

    var errorDescription: String? {
        switch self {
        case .registrationFailed:
            return "Unable to enable launch at login"
        case .unregistrationFailed:
            return "Unable to disable launch at login"
        }
    }
}

class LoginItemManager {
    static let shared = LoginItemManager()

    private let service = SMAppService.mainApp

    private init() {}

    /// Returns actual system state (user decision: reflect actual state)
    func isEnabled() -> Bool {
        service.status == .enabled
    }

    /// Enable or disable launch at login
    func setEnabled(_ enabled: Bool) throws {
        if enabled {
            guard service.status != .enabled else { return }

            do {
                try service.register()
            } catch {
                // User decision: show guidance if blocked
                showSystemSettingsGuidance()
                throw LoginItemError.registrationFailed
            }

            // Verify registration succeeded
            if service.status != .enabled {
                showSystemSettingsGuidance()
                throw LoginItemError.registrationFailed
            }
        } else {
            guard service.status != .notRegistered else { return }

            do {
                try service.unregister()
            } catch {
                throw LoginItemError.unregistrationFailed
            }
        }
    }

    /// User decision: show guidance to System Settings if macOS blocks
    private func showSystemSettingsGuidance() {
        DispatchQueue.main.async {
            let alert = NSAlert()
            alert.messageText = "Unable to Enable Launch at Login"
            alert.informativeText = """
            macOS blocked the request to launch at login.

            To enable manually:
            1. Open System Settings
            2. Go to General → Login Items
            3. Add DictationApp under "Open at Login"
            """
            alert.alertStyle = .informational
            alert.addButton(withTitle: "Open System Settings")
            alert.addButton(withTitle: "Cancel")

            if alert.runModal() == .alertFirstButtonReturn {
                // Open System Settings to Login Items
                if let url = URL(string: "x-apple.systempreferences:com.apple.LoginItems-Settings.extension") {
                    NSWorkspace.shared.open(url)
                }
            }
        }
    }
}
```

Ensure directory structure:
- DictationApp/Sources/Services/LoginItemManager.swift

Add file to Xcode project if needed.
  </action>
  <verify>
- File exists: `ls DictationApp/Sources/Services/LoginItemManager.swift`
- Build succeeds with ServiceManagement import
  </verify>
  <done>
LoginItemManager wraps SMAppService, returns actual system state, and shows guidance alert when registration fails.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire menu toggle to LoginItemManager</name>
  <files>
    DictationApp/Sources/App/AppDelegate.swift
  </files>
  <action>
Update AppDelegate.swift to use LoginItemManager for the "Launch at Login" toggle:

1. Update setupMenuBar() to set initial toggle state:

Find this line in setupMenuBar():
```swift
let launchToggle = NSMenuItem(title: "Launch at Login", action: #selector(toggleLaunchAtLogin(_:)), keyEquivalent: "")
launchToggle.state = .off  // Will be updated in Plan 03
```

Replace with:
```swift
let launchToggle = NSMenuItem(title: "Launch at Login", action: #selector(toggleLaunchAtLogin(_:)), keyEquivalent: "")
// User decision: reflect actual system state
launchToggle.state = LoginItemManager.shared.isEnabled() ? .on : .off
```

2. Update toggleLaunchAtLogin method:

Find and replace:
```swift
@objc func toggleLaunchAtLogin(_ sender: NSMenuItem) {
    // Placeholder - implemented in Plan 03
    sender.state = sender.state == .on ? .off : .on
}
```

With:
```swift
@objc func toggleLaunchAtLogin(_ sender: NSMenuItem) {
    let manager = LoginItemManager.shared
    let currentState = manager.isEnabled()

    do {
        try manager.setEnabled(!currentState)
        // User decision: reflect actual system state after change
        sender.state = manager.isEnabled() ? .on : .off
    } catch {
        // Show error but don't change toggle state
        let alert = NSAlert()
        alert.messageText = "Unable to Change Launch at Login"
        alert.informativeText = error.localizedDescription
        alert.alertStyle = .warning
        alert.runModal()

        // Ensure toggle reflects actual state
        sender.state = manager.isEnabled() ? .on : .off
    }
}
```

3. Ensure the toggle updates when menu opens (in case external change):

Add this method to AppDelegate:
```swift
func menuWillOpen(_ menu: NSMenu) {
    // Update Launch at Login state each time menu opens
    if let launchItem = menu.item(withTitle: "Launch at Login") {
        launchItem.state = LoginItemManager.shared.isEnabled() ? .on : .off
    }
}
```

And make AppDelegate conform to NSMenuDelegate:
```swift
class AppDelegate: NSObject, NSApplicationDelegate, NSMenuDelegate {
```

And in setupMenuBar(), after creating the menu:
```swift
menu.delegate = self
```
  </action>
  <verify>
- Build: `xcodebuild -project DictationApp/DictationApp.xcodeproj -scheme DictationApp build`
- Run app, check menu → "Launch at Login" shows correct state
- Toggle on → verify in System Settings > General > Login Items
- Toggle off → verify removed from Login Items
- If blocked, guidance alert appears with "Open System Settings" button
  </verify>
  <done>
Menu bar "Launch at Login" toggle works with SMAppService, reflects actual system state, and shows guidance when blocked.
  </done>
</task>

</tasks>

<verification>
1. Build succeeds with LoginItemManager
2. Launch app → click menu → "Launch at Login" shows current state
3. Click toggle (if currently off) → should turn on (checkmark)
4. Open System Settings > General > Login Items → DictationApp listed
5. Click toggle again → turns off, removed from Login Items
6. Close and reopen menu → toggle state persists correctly
7. If macOS blocks registration → guidance alert appears
8. "Open System Settings" button in alert opens correct settings pane
</verification>

<success_criteria>
- LoginItemManager uses SMAppService (macOS 13+)
- Toggle reflects actual system state, not cached preference
- Toggle state updates each time menu opens
- Guidance alert shown when registration blocked
- "Open System Settings" button deep-links to Login Items
- Matches user decisions: toggle in menu only, no first-run prompt, show guidance if blocked
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-settings/01-03-SUMMARY.md`
</output>
