---
phase: 01-foundation-settings
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - DictationApp/Sources/Services/KeychainManager.swift
  - DictationApp/Sources/Services/APIClient.swift
  - DictationApp/Sources/Views/SettingsView.swift
  - DictationApp/Sources/App/AppDelegate.swift
autonomous: true

must_haves:
  truths:
    - "User can open settings window from menu bar"
    - "User can enter API key in masked field"
    - "User can save API key and it persists after app restart"
    - "User sees error alert if API key validation fails"
  artifacts:
    - path: "DictationApp/Sources/Services/KeychainManager.swift"
      provides: "Secure API key storage"
      exports: ["KeychainManager"]
    - path: "DictationApp/Sources/Services/APIClient.swift"
      provides: "API key validation"
      exports: ["APIClient", "APIError"]
    - path: "DictationApp/Sources/Views/SettingsView.swift"
      provides: "Settings UI with SecureField"
      min_lines: 80
  key_links:
    - from: "DictationApp/Sources/Views/SettingsView.swift"
      to: "KeychainManager"
      via: "saveAPIKey/loadAPIKey calls"
      pattern: "KeychainManager\\.shared\\.(save|load)APIKey"
    - from: "DictationApp/Sources/Views/SettingsView.swift"
      to: "APIClient"
      via: "validateAPIKey call on save"
      pattern: "APIClient\\.shared\\.validateAPIKey"
    - from: "DictationApp/Sources/App/AppDelegate.swift"
      to: "SettingsView"
      via: "NSHostingController presentation"
      pattern: "SettingsView"
---

<objective>
Implement settings window with API key entry, Keychain storage, and validation.

Purpose: Enables users to configure their Groq API key securely. This is the core configuration that enables all transcription functionality in later phases.

Output: Working settings window with masked API key input, auto-validation on save, and secure Keychain storage.
</objective>

<execution_context>
@/Users/justindeisler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/justindeisler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-settings/01-RESEARCH.md
@.planning/phases/01-foundation-settings/01-CONTEXT.md
@.planning/phases/01-foundation-settings/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement KeychainManager and APIClient</name>
  <files>
    DictationApp/Sources/Services/KeychainManager.swift
    DictationApp/Sources/Services/APIClient.swift
  </files>
  <action>
Create KeychainManager.swift using KeychainAccess library:

```swift
import Foundation
import KeychainAccess

class KeychainManager {
    static let shared = KeychainManager()

    private let keychain = Keychain(service: "com.dictationapp.DictationApp")
    private let apiKeyKey = "groq_api_key"

    private init() {}

    func saveAPIKey(_ key: String) throws {
        try keychain.set(key, key: apiKeyKey)
    }

    func loadAPIKey() -> String? {
        try? keychain.get(apiKeyKey)
    }

    func deleteAPIKey() throws {
        try keychain.remove(apiKeyKey)
    }

    func hasAPIKey() -> Bool {
        loadAPIKey() != nil
    }
}
```

Create APIClient.swift with validation endpoint:

```swift
import Foundation

enum APIError: LocalizedError {
    case invalidAPIKey
    case rateLimitExceeded
    case serverError(Int)
    case networkError(Error)
    case invalidResponse
    case timeout

    var errorDescription: String? {
        userMessage
    }

    var userMessage: String {
        switch self {
        case .invalidAPIKey:
            return "The API key is invalid. Please check your key at console.groq.com"
        case .rateLimitExceeded:
            return "Rate limit exceeded. Please wait a few minutes and try again."
        case .serverError(let code):
            return "Server error (\(code)). Please try again later."
        case .networkError:
            return "Unable to connect to Groq API. Please check your internet connection."
        case .invalidResponse:
            return "Unexpected response from API. Please try again."
        case .timeout:
            return "Request timed out. Please check your internet connection and try again."
        }
    }
}

class APIClient {
    static let shared = APIClient()

    private let baseURL = "https://api.groq.com/openai/v1"
    private let session: URLSession

    private init() {
        let config = URLSessionConfiguration.default
        config.timeoutIntervalForRequest = 10  // 10 second timeout for validation
        config.timeoutIntervalForResource = 10
        session = URLSession(configuration: config)
    }

    /// Validates API key by calling the models endpoint (fast, free)
    func validateAPIKey(_ key: String) async throws {
        guard let url = URL(string: "\(baseURL)/models") else {
            throw APIError.invalidResponse
        }

        var request = URLRequest(url: url)
        request.setValue("Bearer \(key)", forHTTPHeaderField: "Authorization")
        request.httpMethod = "GET"

        let (_, response): (Data, URLResponse)
        do {
            (_, response) = try await session.data(for: request)
        } catch let error as URLError where error.code == .timedOut {
            throw APIError.timeout
        } catch {
            throw APIError.networkError(error)
        }

        guard let httpResponse = response as? HTTPURLResponse else {
            throw APIError.invalidResponse
        }

        switch httpResponse.statusCode {
        case 200:
            return  // Valid API key
        case 401:
            throw APIError.invalidAPIKey
        case 429:
            throw APIError.rateLimitExceeded
        default:
            throw APIError.serverError(httpResponse.statusCode)
        }
    }
}
```

Ensure directory structure:
- DictationApp/Sources/Services/KeychainManager.swift
- DictationApp/Sources/Services/APIClient.swift

Add files to Xcode project if needed.
  </action>
  <verify>
- Files exist: `ls DictationApp/Sources/Services/`
- Build succeeds with new files included
  </verify>
  <done>
KeychainManager can save/load API keys securely. APIClient can validate API keys against Groq's models endpoint with proper error handling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement SettingsView with Save/Cancel behavior</name>
  <files>
    DictationApp/Sources/Views/SettingsView.swift
    DictationApp/Sources/App/AppDelegate.swift
  </files>
  <action>
Create SettingsView.swift per user decisions (single view, native style, explicit save):

```swift
import SwiftUI

struct SettingsView: View {
    @State private var apiKey: String = ""
    @State private var originalAPIKey: String = ""
    @State private var isValidating = false
    @State private var showValidationError = false
    @State private var validationError: String = ""

    @Environment(\.dismiss) private var dismiss

    var body: some View {
        VStack(spacing: 0) {
            // Content area - single view layout per user decision
            Form {
                Section {
                    SecureField("Enter your Groq API key", text: $apiKey)
                        .textFieldStyle(.roundedBorder)
                        .help("Your API key from console.groq.com")

                    Link("Get your API key from console.groq.com",
                         destination: URL(string: "https://console.groq.com/keys")!)
                        .font(.caption)
                        .foregroundStyle(.secondary)
                } header: {
                    Text("API Configuration")
                        .font(.headline)
                }
            }
            .formStyle(.grouped)
            .scrollDisabled(true)  // All settings visible at once
            .padding()

            Divider()

            // Button bar - explicit save behavior per user decision
            HStack(spacing: 12) {
                Button("Cancel") {
                    apiKey = originalAPIKey  // Discard changes
                    closeWindow()
                }
                .keyboardShortcut(.cancelAction)

                Spacer()

                if isValidating {
                    ProgressView()
                        .scaleEffect(0.7)
                        .frame(width: 16, height: 16)
                    Text("Validating...")
                        .font(.caption)
                        .foregroundStyle(.secondary)
                }

                Button("Save") {
                    Task {
                        await validateAndSave()
                    }
                }
                .keyboardShortcut(.defaultAction)
                .disabled(apiKey.isEmpty || apiKey == originalAPIKey || isValidating)
            }
            .padding()
            .background(Color(nsColor: .windowBackgroundColor))
        }
        .frame(width: 500, height: 250)
        .onAppear {
            loadCurrentSettings()
        }
        .alert("API Key Validation Failed", isPresented: $showValidationError) {
            Button("OK") { }
        } message: {
            Text(validationError)
        }
    }

    private func loadCurrentSettings() {
        if let savedKey = KeychainManager.shared.loadAPIKey() {
            apiKey = savedKey
            originalAPIKey = savedKey
        }
    }

    private func validateAndSave() async {
        isValidating = true

        do {
            // User decision: auto-validate on save
            try await APIClient.shared.validateAPIKey(apiKey)

            // Save to Keychain
            try KeychainManager.shared.saveAPIKey(apiKey)

            // Update original to prevent re-save prompt
            originalAPIKey = apiKey

            // Close window on success
            await MainActor.run {
                closeWindow()
            }
        } catch let error as APIError {
            // User decision: alert dialog on validation failure
            validationError = error.userMessage
            showValidationError = true
        } catch {
            validationError = "Unable to save API key. Please try again."
            showValidationError = true
        }

        isValidating = false
    }

    private func closeWindow() {
        NSApp.keyWindow?.close()
    }
}

#Preview {
    SettingsView()
}
```

Update AppDelegate.swift to present SettingsView in floating window:

Update the `openSettings()` method:

```swift
@objc func openSettings() {
    if settingsWindowController == nil {
        let settingsView = SettingsView()
        let hostingController = NSHostingController(rootView: settingsView)

        let window = NSWindow(contentViewController: hostingController)
        window.title = "DictationApp Settings"
        window.styleMask = [.titled, .closable]  // No resize - fixed layout
        window.setContentSize(NSSize(width: 500, height: 250))
        window.center()

        // User decision: separate floating window
        window.level = .floating
        window.isMovableByWindowBackground = true

        settingsWindowController = NSWindowController(window: window)
    }

    settingsWindowController?.showWindow(nil)
    NSApp.activate(ignoringOtherApps: true)
}
```

Ensure directory structure:
- DictationApp/Sources/Views/SettingsView.swift

Add file to Xcode project if needed.
  </action>
  <verify>
- Build: `xcodebuild -project DictationApp/DictationApp.xcodeproj -scheme DictationApp build`
- Run app, click Settings in menu
- Settings window opens as floating window
- Enter API key (shows dots), click Save
- If invalid key: alert shows error message
- If valid key: window closes, key persists after quit/relaunch
  </verify>
  <done>
Settings window opens from menu bar, shows masked API key field, validates on save with alert on failure, saves valid keys to Keychain that persist across restarts.
  </done>
</task>

</tasks>

<verification>
1. Build succeeds with all new files
2. Click "Settings" in menu bar → floating window opens
3. API key field shows dots (masked input)
4. Cancel button closes window without saving
5. Save button disabled when field empty or unchanged
6. Save with invalid key → alert dialog with error message
7. Save with valid Groq API key → window closes
8. Quit and relaunch → Settings shows saved key (as dots)
9. Keychain Access app shows entry for com.dictationapp.DictationApp
</verification>

<success_criteria>
- KeychainManager stores API keys securely in macOS Keychain
- APIClient validates keys against Groq API (models endpoint)
- SettingsView matches user decisions: single view, native style, masked input, explicit save
- API key persists across app restarts
- Validation errors show clear alert dialogs
- Window floats above other windows per user decision
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-settings/01-02-SUMMARY.md`
</output>
