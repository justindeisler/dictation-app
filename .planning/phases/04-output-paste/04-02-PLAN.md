---
phase: 04-output-paste
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - DictationApp/Sources/App/AppDelegate.swift
autonomous: false

must_haves:
  truths:
    - "Transcription completion triggers automatic paste"
    - "Notification delegate handles copy-to-clipboard action"
    - "Notification categories registered at app launch"
    - "Paste works in TextEdit, Notes, VS Code, and browsers"
  artifacts:
    - path: "DictationApp/Sources/App/AppDelegate.swift"
      provides: "Notification delegate and transcription observers"
      contains: "UNUserNotificationCenterDelegate"
  key_links:
    - from: "AppDelegate.handleTranscriptionComplete"
      to: "PasteManager.pasteText"
      via: "async call on transcription notification"
      pattern: "PasteManager.*pasteText"
    - from: "AppDelegate"
      to: "UNUserNotificationCenter"
      via: "notification delegate"
      pattern: "UNUserNotificationCenterDelegate"
    - from: ".transcriptionDidComplete"
      to: "handleTranscriptionComplete"
      via: "NotificationCenter observer"
      pattern: "transcriptionDidComplete"
---

<objective>
Integrate PasteManager with AppDelegate and notifications

Purpose: Wire up the transcription-complete notification to trigger automatic paste, set up UNUserNotificationCenter delegate for copy-to-clipboard action handling, and register notification categories at app launch.

Output: AppDelegate updated with notification infrastructure and transcription observers that connect Phase 3 output to Phase 4 paste.
</objective>

<execution_context>
@/Users/justindeisler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/justindeisler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-output-paste/04-RESEARCH.md
@.planning/phases/04-output-paste/04-CONTEXT.md
@.planning/phases/04-output-paste/04-01-SUMMARY.md

# Files to modify
@DictationApp/Sources/App/AppDelegate.swift
@DictationApp/Sources/Services/PasteManager.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add notification infrastructure and transcription observer to AppDelegate</name>
  <files>
    DictationApp/Sources/App/AppDelegate.swift
  </files>
  <action>
1. Update `DictationApp/Sources/App/AppDelegate.swift`:

   First, add UserNotifications import at the top:
   ```swift
   import UserNotifications
   ```

   Then, add UNUserNotificationCenterDelegate conformance to the class declaration:
   ```swift
   @MainActor
   class AppDelegate: NSObject, NSApplicationDelegate, NSMenuDelegate, UNUserNotificationCenterDelegate {
   ```

   In `applicationDidFinishLaunching(_:)`, add notification and transcription observer setup:
   ```swift
   func applicationDidFinishLaunching(_ notification: Notification) {
       setupMenuBar()
       setupRecordingStateObservers()
       setupNotifications()              // NEW: Notification infrastructure
       setupTranscriptionObservers()     // NEW: Wire transcription to paste
       HotkeyManager.shared.setupHotkey()

       // Check and request accessibility permission at launch (PRM-02)
       // Required for Phase 4 paste functionality
       if !PermissionManager.shared.checkAccessibilityPermission() {
           PermissionManager.shared.requestAccessibilityPermission()
       }
   }
   ```

   Add the notification setup method (place after setupRecordingStateObservers):
   ```swift
   // MARK: - Notification Setup

   private func setupNotifications() {
       let center = UNUserNotificationCenter.current()
       center.delegate = self

       // Define "Copy to Clipboard" action for transcription notifications
       let copyAction = UNNotificationAction(
           identifier: "COPY_ACTION",
           title: "Copy to Clipboard",
           options: .foreground
       )

       let category = UNNotificationCategory(
           identifier: "TRANSCRIPTION_READY",
           actions: [copyAction],
           intentIdentifiers: [],
           options: []
       )

       center.setNotificationCategories([category])

       // Request notification authorization
       center.requestAuthorization(options: [.alert, .sound]) { granted, error in
           if let error = error {
               print("Notification authorization error: \(error)")
           } else if granted {
               print("Notification permission granted")
           }
       }
   }
   ```

   Add transcription observer setup method:
   ```swift
   // MARK: - Transcription Observers

   private func setupTranscriptionObservers() {
       NotificationCenter.default.addObserver(
           self,
           selector: #selector(handleTranscriptionComplete),
           name: .transcriptionDidComplete,
           object: nil
       )
   }

   @objc func handleTranscriptionComplete(_ notification: Notification) {
       guard let text = notification.object as? String else {
           print("Transcription notification missing text")
           return
       }

       // Trigger automatic paste (OUT-03)
       Task {
           await PasteManager.shared.pasteText(text)
       }
   }
   ```

   Add UNUserNotificationCenterDelegate methods at the end of the class:
   ```swift
   // MARK: - UNUserNotificationCenterDelegate

   func userNotificationCenter(
       _ center: UNUserNotificationCenter,
       didReceive response: UNNotificationResponse,
       withCompletionHandler completionHandler: @escaping () -> Void
   ) {
       // Handle "Copy to Clipboard" action
       if response.actionIdentifier == "COPY_ACTION" {
           let text = response.notification.request.content.body
           let pasteboard = NSPasteboard.general
           pasteboard.clearContents()
           pasteboard.setString(text, forType: .string)
           print("Transcription copied to clipboard from notification action")
       }

       completionHandler()
   }

   func userNotificationCenter(
       _ center: UNUserNotificationCenter,
       willPresent notification: UNNotification,
       withCompletionHandler completionHandler: @escaping (UNNotificationPresentationOptions) -> Void
   ) {
       // Show notification even when app is in foreground
       completionHandler([.banner, .sound])
   }
   ```
  </action>
  <verify>
  Build succeeds and integration is correct:
  ```bash
  cd /Users/justindeisler/Desktop/Developing/Projects/DictationApp && xcodebuild -project DictationApp/DictationApp.xcodeproj -scheme DictationApp -configuration Debug build 2>&1 | tail -20
  grep -n "UNUserNotificationCenterDelegate" DictationApp/Sources/App/AppDelegate.swift
  grep -n "handleTranscriptionComplete" DictationApp/Sources/App/AppDelegate.swift
  grep -n "PasteManager" DictationApp/Sources/App/AppDelegate.swift
  grep -n "COPY_ACTION" DictationApp/Sources/App/AppDelegate.swift
  ```
  </verify>
  <done>
  - AppDelegate conforms to UNUserNotificationCenterDelegate
  - setupNotifications() registers TRANSCRIPTION_READY category with COPY_ACTION
  - setupTranscriptionObservers() connects .transcriptionDidComplete to handleTranscriptionComplete
  - handleTranscriptionComplete calls PasteManager.shared.pasteText()
  - Notification delegate methods handle copy action and foreground presentation
  - Build succeeds
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Phase 4 automatic paste workflow:
    - PasteManager service with clipboard + CGEvent paste simulation
    - Focused text field detection via Accessibility API
    - Smart spacing (adds space if cursor isn't at start or after whitespace)
    - Notification fallback with "Copy to Clipboard" action
    - End-to-end: Option+Space to record, release to transcribe, text appears in active field
  </what-built>
  <how-to-verify>
    1. Build and run the app:
       ```bash
       cd /Users/justindeisler/Desktop/Developing/Projects/DictationApp
       xcodebuild -project DictationApp/DictationApp.xcodeproj -scheme DictationApp -configuration Debug build
       open DictationApp/DictationApp.xcodeproj
       # Run with Cmd+R in Xcode
       ```

    2. Grant permissions if prompted:
       - Accessibility permission (required for paste simulation)
       - Notification permission (for fallback notifications)

    3. Test paste in TextEdit (OUT-01, OUT-02):
       - Open TextEdit (or create new document)
       - Click in the text area to focus
       - Press Option+Space to start recording
       - Speak clearly: "This is a test of automatic paste"
       - Press Option+Space to stop
       - VERIFY: Text appears in TextEdit without manual paste
       - VERIFY: Xcode console shows "Text pasted successfully"

    4. Test paste in VS Code (OUT-02):
       - Open VS Code with a file
       - Click in the editor to focus
       - Press Option+Space, speak, press Option+Space
       - VERIFY: Text appears in VS Code editor

    5. Test paste in browser text field (OUT-02):
       - Open Safari or Chrome
       - Navigate to a page with a text field (e.g., Google search)
       - Click in the search box
       - Press Option+Space, speak, press Option+Space
       - VERIFY: Text appears in browser text field

    6. Test smart spacing:
       - In TextEdit, type "Hello" (no trailing space)
       - Press Option+Space, speak "world", press Option+Space
       - VERIFY: Result is "Hello world" (space automatically added)
       - Now type "Test " (with trailing space)
       - Press Option+Space, speak "again", press Option+Space
       - VERIFY: Result is "Test again" (no double space)

    7. Test notification fallback:
       - Click somewhere that is NOT a text field (e.g., desktop, menu bar)
       - Press Option+Space, speak, press Option+Space
       - VERIFY: Notification appears with transcription text
       - Click "Copy to Clipboard" action on notification
       - Paste somewhere manually (Cmd+V)
       - VERIFY: Pasted text matches transcription

    8. Test empty transcription handling:
       - Press Option+Space, say nothing (silence), press Option+Space quickly
       - VERIFY: No notification appears, no paste attempt
       - VERIFY: Console shows "Empty transcription - skipping paste"

    9. Expected console output pattern:
       ```
       Recording started...
       Recording stopped. File saved to: /var/folders/.../audio_XXXXXX.wav
       Starting transcription for: audio_XXXXXX.wav
       Transcription complete: [transcribed text]
       Text pasted successfully: [transcribed text]...
       ```

    Note: If paste fails in certain apps, check:
    - Accessibility permission is granted (System Settings > Privacy & Security > Accessibility)
    - The app supports standard paste (Cmd+V)
  </how-to-verify>
  <resume-signal>
    Type "approved" if automatic paste works in TextEdit, VS Code, and browser.
    If issues, describe what's happening (e.g., "paste works in TextEdit but not VS Code", "notification appears but copy action doesn't work").
  </resume-signal>
</task>

</tasks>

<verification>
Phase 4 requirements coverage:
- OUT-01: Transcribed text pasted into active text field ✓ (PasteManager.pasteText -> CGEvent Cmd+V)
- OUT-02: Paste works across standard macOS apps ✓ (verified in checkpoint: TextEdit, VS Code, browser)
- OUT-03: User does not need to manually paste ✓ (automatic trigger via .transcriptionDidComplete observer)

```bash
# Verify all Phase 4 components
grep -l "PasteManager" DictationApp/Sources/App/AppDelegate.swift
grep -l "NSPasteboard.general" DictationApp/Sources/Services/PasteManager.swift
grep -l "CGEvent" DictationApp/Sources/Services/PasteManager.swift
grep -l "transcriptionDidComplete" DictationApp/Sources/App/AppDelegate.swift
grep -l "TRANSCRIPTION_READY" DictationApp/Sources/App/AppDelegate.swift
```
</verification>

<success_criteria>
- [ ] Project builds successfully
- [ ] AppDelegate sets up notification infrastructure
- [ ] Transcription observer connects to PasteManager
- [ ] Notification delegate handles copy action
- [ ] Text automatically pastes in TextEdit
- [ ] Text automatically pastes in VS Code
- [ ] Text automatically pastes in browser text fields
- [ ] Smart spacing works correctly
- [ ] Notification fallback works when no text field focused
- [ ] Empty transcriptions handled silently
- [ ] All 3 OUT requirements covered
</success_criteria>

<output>
After completion, create `.planning/phases/04-output-paste/04-02-SUMMARY.md`
</output>
