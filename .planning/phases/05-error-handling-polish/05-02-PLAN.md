---
phase: 05-error-handling-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - DictationApp/Sources/Services/HotkeyManager.swift
  - DictationApp/Sources/App/AppDelegate.swift
autonomous: true

must_haves:
  truths:
    - "User is prompted to configure API key if missing when pressing hotkey"
    - "User can open Settings directly from missing API key alert"
    - "User can get help obtaining API key from alert"
  artifacts:
    - path: "DictationApp/Sources/Services/HotkeyManager.swift"
      provides: "API key check before recording"
      contains: "checkAPIKeyBeforeRecording"
    - path: "DictationApp/Sources/App/AppDelegate.swift"
      provides: "Missing API key alert with Settings and Get Key buttons"
      contains: "showMissingAPIKeyAlert"
  key_links:
    - from: "HotkeyManager.swift"
      to: "KeychainManager.swift"
      via: "loadAPIKey check before recording"
      pattern: "KeychainManager\\.shared\\.loadAPIKey"
    - from: "AppDelegate.swift"
      to: "openSettings"
      via: "alert button opens settings"
      pattern: "openSettings"
---

<objective>
Handle missing API key gracefully with blocking alert and recovery options (ERR-03)

Purpose: Users need clear guidance when API key is missing. The app should prompt configuration BEFORE attempting transcription, not after it fails.

Output: API key validation in HotkeyManager, missing API key alert in AppDelegate
</objective>

<execution_context>
@/Users/justindeisler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/justindeisler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-error-handling-polish/05-RESEARCH.md

# Current infrastructure
@DictationApp/Sources/Services/KeychainManager.swift (loadAPIKey, hasAPIKey)
@DictationApp/Sources/Services/HotkeyManager.swift (handleHotkeyPressed)
@DictationApp/Sources/App/AppDelegate.swift (openSettings method exists)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add missing API key alert method to AppDelegate</name>
  <files>DictationApp/Sources/App/AppDelegate.swift</files>
  <action>
Add to AppDelegate.swift a new method `showMissingAPIKeyAlert()`:

```swift
/// Show blocking alert when API key is missing (ERR-03)
func showMissingAPIKeyAlert() {
    let alert = NSAlert()
    alert.messageText = "API Key Required"
    alert.informativeText = """
    DictationApp needs a Groq API key to transcribe your recordings.

    You can get a free API key from console.groq.com
    """
    alert.alertStyle = .informational
    alert.addButton(withTitle: "Open Settings")
    alert.addButton(withTitle: "Get API Key")
    alert.addButton(withTitle: "Later")

    let response = alert.runModal()

    switch response {
    case .alertFirstButtonReturn:  // Open Settings
        openSettings()

    case .alertSecondButtonReturn: // Get API Key
        if let url = URL(string: "https://console.groq.com/keys") {
            NSWorkspace.shared.open(url)
        }

    default:
        break  // Later - do nothing
    }
}
```

This is a blocking NSAlert (appropriate for ERR-03 per research) because the app cannot function without an API key. The alert provides three actions:
1. Open Settings - direct path to configure
2. Get API Key - opens Groq console in browser
3. Later - dismisses without action

Place this method near the other alert methods (showShortcuts, checkForUpdates).
  </action>
  <verify>Project builds and grep confirms showMissingAPIKeyAlert method exists in AppDelegate.swift</verify>
  <done>AppDelegate has showMissingAPIKeyAlert method with Settings and Get Key buttons</done>
</task>

<task type="auto">
  <name>Task 2: Add API key check in HotkeyManager before recording</name>
  <files>DictationApp/Sources/Services/HotkeyManager.swift</files>
  <action>
Modify HotkeyManager.swift to check for API key before starting recording:

1. Add a private helper method:
```swift
/// Check if API key is configured (ERR-03)
/// - Returns: true if API key exists, false otherwise
private func checkAPIKeyBeforeRecording() -> Bool {
    guard KeychainManager.shared.hasAPIKey() else {
        // Get AppDelegate reference to show alert
        if let appDelegate = NSApp.delegate as? AppDelegate {
            appDelegate.showMissingAPIKeyAlert()
        }
        return false
    }
    return true
}
```

2. In `handleHotkeyPressed()`, add API key check at the START of the else branch (before permission checks), when NOT already recording:

```swift
} else {
    // Check API key FIRST before even checking permissions (ERR-03)
    // No point recording if we can't transcribe
    guard checkAPIKeyBeforeRecording() else {
        return
    }

    // Check microphone permission before recording (PRM-01)
    let micStatus = permission.checkMicrophonePermission()
    // ... rest of existing code
}
```

Rationale: Check API key before microphone permission because:
1. It's faster (no async permission request)
2. User gets immediate feedback
3. No point recording if transcription will fail

Import AppKit at top if not already present (needed for NSApp.delegate).
  </action>
  <verify>Project builds and grep confirms checkAPIKeyBeforeRecording method exists and is called in handleHotkeyPressed</verify>
  <done>HotkeyManager checks for API key before recording and shows alert if missing</done>
</task>

</tasks>

<verification>
1. Build succeeds: `xcodebuild -project DictationApp/DictationApp.xcodeproj -scheme DictationApp build`
2. HotkeyManager.swift contains checkAPIKeyBeforeRecording method
3. HotkeyManager calls checkAPIKeyBeforeRecording before permission checks
4. AppDelegate.swift contains showMissingAPIKeyAlert method
5. Alert has three buttons: Open Settings, Get API Key, Later
</verification>

<success_criteria>
1. When user presses hotkey without API key configured, blocking alert appears immediately
2. User can click "Open Settings" to configure API key
3. User can click "Get API Key" to open Groq console in browser
4. User can click "Later" to dismiss without action
5. Recording does not start if API key is missing
</success_criteria>

<output>
After completion, create `.planning/phases/05-error-handling-polish/05-02-SUMMARY.md`
</output>
