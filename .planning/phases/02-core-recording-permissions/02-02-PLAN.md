---
phase: 02-core-recording-permissions
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - DictationApp/Sources/Services/HotkeyManager.swift
  - DictationApp/Sources/App/AppDelegate.swift
  - DictationApp/DictationApp.xcodeproj/project.pbxproj
  - DictationApp/Package.swift
autonomous: false

must_haves:
  truths:
    - "User can press Option+Space to start recording"
    - "User can press Option+Space again to stop recording"
    - "Menu bar icon changes to red/filled while recording"
    - "User is prompted for microphone permission on first recording attempt"
    - "User sees guidance if permissions are denied"
  artifacts:
    - path: "DictationApp/Sources/Services/HotkeyManager.swift"
      provides: "Global hotkey registration and toggle logic"
      min_lines: 50
      exports: ["HotkeyManager"]
    - path: "DictationApp/Sources/App/AppDelegate.swift"
      provides: "Menu bar icon state changes and recording state observers"
      contains: "updateMenuBarIcon"
  key_links:
    - from: "HotkeyManager"
      to: "KeyboardShortcuts"
      via: "onKeyUp handler"
      pattern: "KeyboardShortcuts\\.onKeyUp"
    - from: "HotkeyManager"
      to: "AudioRecorder"
      via: "startRecording/stopRecording calls"
      pattern: "AudioRecorder\\.shared\\.(start|stop)Recording"
    - from: "HotkeyManager"
      to: "PermissionManager"
      via: "permission check before recording"
      pattern: "PermissionManager\\.shared\\.check"
    - from: "AppDelegate"
      to: "NotificationCenter"
      via: "recording state observers"
      pattern: "NotificationCenter\\.default\\.addObserver.*recording"
---

<objective>
Implement global hotkey detection (Option+Space) and visual recording feedback in the menu bar.

Purpose: This plan wires together the permission and audio recording services with user interaction - the hotkey trigger and visual feedback complete the recording workflow.

Output: HotkeyManager service, updated AppDelegate with icon state changes, KeyboardShortcuts dependency added.
</objective>

<execution_context>
@/Users/justindeisler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/justindeisler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/02-core-recording-permissions/02-RESEARCH.md
@.planning/phases/02-core-recording-permissions/02-01-SUMMARY.md
@DictationApp/Sources/Services/PermissionManager.swift
@DictationApp/Sources/Services/AudioRecorder.swift
@DictationApp/Sources/App/AppDelegate.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add KeyboardShortcuts dependency and create HotkeyManager</name>
  <files>DictationApp/Sources/Services/HotkeyManager.swift, DictationApp/DictationApp.xcodeproj/project.pbxproj</files>
  <action>
1. Add KeyboardShortcuts package to the Xcode project:
   - Open Package.swift or add via Xcode SPM: https://github.com/sindresorhus/KeyboardShortcuts (version 2.x)
   - The project may not have Package.swift - in that case, add as Xcode Swift Package dependency

2. Create HotkeyManager.swift following established patterns:

```swift
import KeyboardShortcuts
import Foundation

// Define the hotkey name with default Option+Space
extension KeyboardShortcuts.Name {
    static let toggleRecording = Self(
        "toggleRecording",
        default: .init(.space, modifiers: [.option])
    )
}

// Notification names for recording state changes
extension Notification.Name {
    static let recordingDidStart = Notification.Name("recordingDidStart")
    static let recordingDidStop = Notification.Name("recordingDidStop")
}

@MainActor
final class HotkeyManager {
    static let shared = HotkeyManager()

    private init() {}

    func setupHotkey() {
        KeyboardShortcuts.onKeyUp(for: .toggleRecording) { [weak self] in
            Task { @MainActor in
                await self?.handleHotkeyPressed()
            }
        }
    }

    private func handleHotkeyPressed() async {
        let recorder = AudioRecorder.shared
        let permission = PermissionManager.shared

        if recorder.isRecording {
            // Stop recording (REC-02)
            if let recordingURL = recorder.stopRecording() {
                NotificationCenter.default.post(
                    name: .recordingDidStop,
                    object: recordingURL
                )
            }
        } else {
            // Check microphone permission before recording (PRM-01)
            let micStatus = permission.checkMicrophonePermission()

            if micStatus == .notDetermined {
                let granted = await permission.requestMicrophonePermission()
                if !granted {
                    permission.showMicrophonePermissionGuidance()
                    return
                }
            } else if micStatus == .denied {
                permission.showMicrophonePermissionGuidance()
                return
            }

            // Start recording (REC-01)
            do {
                try recorder.startRecording()
                NotificationCenter.default.post(
                    name: .recordingDidStart,
                    object: nil
                )
            } catch {
                // Error handling - basic for Phase 2, expanded in Phase 5
                print("Failed to start recording: \(error.localizedDescription)")
            }
        }
    }
}
```

3. Add HotkeyManager.swift to the Xcode project Sources/Services group

Note: If KeyboardShortcuts cannot be added via SPM in the existing project structure, use Xcode GUI:
- File > Add Package Dependencies
- Enter: https://github.com/sindresorhus/KeyboardShortcuts
- Select version 2.x (up to next major)
  </action>
  <verify>
Build with: cd DictationApp && xcodebuild -scheme DictationApp -configuration Debug build 2>&1 | grep -E "(error:|warning:|BUILD)"

Check KeyboardShortcuts resolved: grep -r "KeyboardShortcuts" DictationApp/

Expected: BUILD SUCCEEDED, KeyboardShortcuts import resolves
  </verify>
  <done>
HotkeyManager.swift exists with:
- KeyboardShortcuts.Name extension defining toggleRecording (Option+Space default)
- Notification.Name extensions for recordingDidStart/recordingDidStop
- setupHotkey() registering the hotkey handler
- handleHotkeyPressed() with permission checking and recording toggle logic
- KeyboardShortcuts package dependency added to project
  </done>
</task>

<task type="auto">
  <name>Task 2: Update AppDelegate with icon state changes and hotkey setup</name>
  <files>DictationApp/Sources/App/AppDelegate.swift</files>
  <action>
Update AppDelegate.swift to handle recording state visual feedback:

1. Add MenuBarIconState enum (inside AppDelegate or as separate type):
```swift
enum MenuBarIconState {
    case idle
    case recording

    var symbolName: String {
        switch self {
        case .idle: return "waveform"
        case .recording: return "waveform.circle.fill"
        }
    }

    var tintColor: NSColor? {
        switch self {
        case .idle: return nil
        case .recording: return .systemRed
        }
    }

    var isTemplate: Bool {
        switch self {
        case .idle: return true
        case .recording: return false
        }
    }
}
```

2. Add method to update menu bar icon:
```swift
func updateMenuBarIcon(state: MenuBarIconState) {
    guard let button = statusItem?.button else { return }

    let image = NSImage(
        systemSymbolName: state.symbolName,
        accessibilityDescription: state == .recording ? "Recording" : "Dictation"
    )
    image?.isTemplate = state.isTemplate

    button.image = image
    button.contentTintColor = state.tintColor
}
```

3. Add recording state observers in applicationDidFinishLaunching:
```swift
func setupRecordingStateObservers() {
    NotificationCenter.default.addObserver(
        self,
        selector: #selector(handleRecordingStarted),
        name: .recordingDidStart,
        object: nil
    )
    NotificationCenter.default.addObserver(
        self,
        selector: #selector(handleRecordingStopped),
        name: .recordingDidStop,
        object: nil
    )
}

@objc func handleRecordingStarted() {
    updateMenuBarIcon(state: .recording)
}

@objc func handleRecordingStopped(_ notification: Notification) {
    updateMenuBarIcon(state: .idle)
    // notification.object contains the recording URL for Phase 3
}
```

4. Call setupRecordingStateObservers() and HotkeyManager.shared.setupHotkey() in applicationDidFinishLaunching()

5. Also check and request accessibility permission at launch (for Phase 4 paste functionality):
```swift
// In applicationDidFinishLaunching, after setupMenuBar()
if !PermissionManager.shared.checkAccessibilityPermission() {
    PermissionManager.shared.requestAccessibilityPermission()
}
```
  </action>
  <verify>
Build with: cd DictationApp && xcodebuild -scheme DictationApp -configuration Debug build 2>&1 | grep -E "(error:|warning:|BUILD)"

Check methods exist: grep -E "updateMenuBarIcon|handleRecordingStarted|setupHotkey" DictationApp/Sources/App/AppDelegate.swift

Expected: BUILD SUCCEEDED, all methods found
  </verify>
  <done>
AppDelegate.swift updated with:
- MenuBarIconState enum with idle/recording states
- updateMenuBarIcon(state:) method changing icon and color
- Recording state observers (handleRecordingStarted/handleRecordingStopped)
- HotkeyManager.shared.setupHotkey() called at launch
- Accessibility permission requested at launch
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete recording toggle workflow:
- Option+Space hotkey registered
- Microphone permission prompt on first use
- Audio recording to temp WAV file
- Menu bar icon changes to red/filled while recording
  </what-built>
  <how-to-verify>
1. Build and run the app: Open DictationApp.xcodeproj in Xcode, press Cmd+R
2. Grant microphone permission when prompted (or if denied, follow guidance to System Settings)
3. Grant accessibility permission when prompted
4. Press Option+Space - expect:
   - Menu bar icon changes from "waveform" to "waveform.circle.fill" (filled, red)
   - Console shows recording started (if running from Xcode)
5. Press Option+Space again - expect:
   - Menu bar icon changes back to "waveform" (outline, adapts to light/dark)
   - Console shows recording stopped with file URL
6. Verify temp file was created: Check console output for recording-*.wav path
7. Test permission denial flow:
   - Revoke microphone permission in System Settings
   - Press Option+Space - should show guidance alert
  </how-to-verify>
  <resume-signal>Type "approved" if recording toggle works with visual feedback, or describe issues</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:

1. Build succeeds with no errors
2. KeyboardShortcuts package resolved and imported
3. Option+Space toggles recording
4. Menu bar icon visually indicates recording state (red/filled when recording)
5. Microphone permission requested on first attempt
6. Guidance shown when permission denied
7. WAV file created in temp directory on stop
</verification>

<success_criteria>
Phase 2 requirements fully covered:
- REC-01: Option+Space starts recording (HotkeyManager + AudioRecorder)
- REC-02: Option+Space again stops recording (toggle logic)
- REC-03: Menu bar icon red/filled while recording (MenuBarIconState)
- REC-04: Audio in Groq-compatible format (16kHz mono WAV in AudioRecorder)
- PRM-01: Microphone permission requested (PermissionManager + HotkeyManager)
- PRM-02: Accessibility permission requested (AppDelegate launch)
- PRM-03: Guidance when denied (PermissionManager guidance methods)
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-recording-permissions/02-02-SUMMARY.md`
</output>
